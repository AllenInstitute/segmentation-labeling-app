<script src="https://assets.crowd.aws/crowd-html-elements.js"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<script src="https://code.highcharts.com/stock/highstock.js"></script>
<script src="https://code.highcharts.com/stock/modules/data.js"></script>
<script src="https://code.highcharts.com/modules/boost.js"></script>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

<style>
	body {
		padding-left: 20px;
		margin-bottom: 20px;
    max-width: 1380px;
    margin: auto;
	}
  .zoom {
    transform: scale(1.50)
  }
  .roi-overlay {
    position: relative;
    /* left: 50;
    top: 50; */
    left: 0;
    top: 0;
    opacity: 1.0;
    z-index: 90;
  }
  .invisible {
    visibility: hidden;
  }
  #roi-mask {
    opacity: 0.5;
    filter: invert(10%) sepia(93%) saturate(7292%) hue-rotate(11deg) brightness(108%) contrast(118%);  /* produces ff0000 from black */
  }
  #roi-outline {
    opacity: 1.0;
    filter: invert(10%) sepia(93%) saturate(7292%) hue-rotate(11deg) brightness(108%) contrast(118%);  /* produces ff0000 from black */
  }
  .colorblind {
    filter: invert(87%) sepia(27%) saturate(6091%) hue-rotate(353deg) brightness(105%) contrast(102%) !important; /* produces #FFC107 from black */
  }
  #play-pause {
    position: relative;
    top: -22;
    left: -10;
    border: none;
    background-color: transparent;
    outline: none;
    cursor: pointer;
  }
  .image-container {
    height: 128;
    width: 128;
    margin-bottom: 40;
    position: relative;
  }
  .image-label{
    width: 128;
    margin-bottom:10;
    font-size: smaller;
  }
  .toggle-button{
    margin-bottom: 10;
    font-size: small;
  }
  .progress-bar {
    flex:10;
    position: relative;
    display:flex;
    flex-basis:100%;
    width: 128px;
    height:5px;
    transition:height 0.3s;
    background:rgba(0,0,0,0.5);
    cursor:ew-resize;
    margin-bottom:20;
  }
  #progress-fill {
    width:0%;
    /* background:#ffc600; */
    background: #d3d3d3;
    flex:10;
    flex-basis:0%;
  }
  .image-container:hover #avg-projection, .image-container:hover #max-projection, .image-container:hover #roi-vid{
    transform: scale(2);
    transition: transform 0.35s ease-in-out;
    position: relative;
    z-index: 100;
    border: 10px solid rgba(235, 235, 235, 1.0);
    border-radius: 10px;
  }
</style>


<crowd-form>
  <crowd-classifier
    name="roiLabel"
    categories="['cell', 'not cell']"
    header="Is the region of interest a cell or not a cell?"
  >
    <classification-target>
      <div class="container">
        <div class="row">
          <div class="col-sm">
            <button class="toggle-button outline" id="toggle-mask" type="button" onclick="toggleMaskOutline()">Show Mask Overlay</button>
          </div>
          <div class="col-sm text-center">
            <button class="toggle-button is-visible" id="toggle-roi" type="button">Hide ROI</button>
          </div>
          <div class="col-sm text-right">
            <button class="toggle-button default-colors" id="toggle-colorblind" type="button" onclick="toggleColorblind()">Colorblind Mode</button>
          </div>
        </div>
        <div class="row no-gutters justify-content-md-center">
          <div class="col-sm">
            <span class="image-label">2p Recording</span>
            <div class="image-container">
              <canvas id="roi-vid" width="128" height="128"></canvas>
            </div>
            <div class="video-controls">
              <div class="progress-bar">
                <div id="progress-fill"></div>
              </div>
              <button id="play-pause" type="button"><i class="material-icons">play_circle_outline</i></button>
            </div>
          </div>
          <div class="col-sm">
            <span class="image-label">Average Projection</span>
            <div class="image-container">
              <canvas id="avg-projection" width="128" height="128"></canvas>
            </div>
          </div>
          <div class="col-sm">
            <span class="image-label">Max Projection</span>
            <div class="image-container">
              <canvas id="max-projection" width="128" height="128"></canvas>
            </div>
          </div>
          <div class="col-sm">
            <span class="image-label">ROI Mask</span>
            <div class="image-container border">
                <img src="../resources/roi_mask_128x128.png"></span>
            </div>
          </div>
        </div>
        <div class="row justify-content-md-center">
          <div class="col" id="hc-container" style="max-width:580px; height:300px;"></div>
        </div>
      </div>
      
    </classification-target>
    
    <full-instructions header="Cell Detection Instructions">
        <p>Decide whether the region of interest is a cell or not.</p>
        <div>
           <p><strong>Example: </strong></p>
           <p><strong>Response: </strong></p>
        </div>
    </full-instructions>

    <short-instructions>
        Decide whether the region of interest is a cell or not. <br>
        <br>
        Jump to a point in the 2p recording by clicking on the chart trace. <br>
        To play a selected time range, click and drag on the chart or adjust
        the navigation slider below the trace, then click "Play Selection".
    </short-instructions>
  </crowd-classifier>
</crowd-form>

<script>
  // --- dummy data  --- //
  function getData(n) {
    var arr = [],
        i,
        x,
        a,
        b,
        c,
        spike;
    for (
        i = 0, x = Date.UTC(new Date().getUTCFullYear(), 0, 1) - n * 36e5;
        i < n;
        i = i + 1, x = x + 36e5
    ) {
        if (i % 100 === 0) {
            a = 2 * Math.random();
        }
        if (i % 1000 === 0) {
            b = 2 * Math.random();
        }
        if (i % 10000 === 0) {
            c = 2 * Math.random();
        }
        if (i % 50000 === 0) {
            spike = 10;
        } else {
            spike = 0;
        }
        arr.push(//[
           // i*1000,
            2 * Math.sin(i / 100) + a + b + c + spike + Math.random()
        //]
        );
    }
    return arr;
}
  let n = 26 * 500, //144000,
    data = getData(n);

  // Create a timer
  var start = +new Date();
  // var video = document.getElementById("roivid");
  let video = new Video("../resources/exp_716956096_4hz_small_128x128.mp4");
  var videoButton = document.getElementById('play-pause');
  var progressFill = document.getElementById("progress-fill");

  // Create the chart
  Highcharts.chart('hc-container', {

    chart : {
      zoomType: 'x',
      events: {
        load: function() {
          var ch = this
          
          playSelection = ch.renderer.button('Play Selection', null, null, function(){
            var extremes = ch.xAxis[0].getExtremes();
            playVideoSelection(video, extremes.min, extremes.max);
          }, {
              zIndex: 20
          }).attr({
            id: 'playSelection',
            align: 'left',
            title: 'Play video selection'
          }).add().align({
            align: 'left',
            x: 15,
            y: 5
          }, false, null);

          zoomButton = ch.renderer.button('Reset zoom', null, null, function(){
            ch.xAxis[0].setExtremes(null, null);
          }, {
              zIndex: 20
          }).attr({
            id: 'resetZoom',
            align: 'right',
            title: 'Reset zoom level 1:1'
          }).add().align({
            align: 'right',
            x: -15,
            y: 5
          }, false, null);
        },
        click: function (event) {
          video.pause();
          video.currentTime = Math.floor(event.xAxis[0].value)
        },
      }
    },

    legend: {
      enabled: false
    },

    caption: {
      text: "Click a point on the ROI trace to jump to that point in the video. "+
            "Select points by dragging on the chart, or by adjusting the navigation bar. "+
            "Play movie for the selected timestamps by clicking the 'Play Selection' button."
      },

    // position: {
    //   spacingLeft: 0,
    //   marginRight: 0
    // },

    // style: {
    //   width: '80%',
    //   height: '100px'
    // },

    title: {
        text: 'Trace of ' + n + ' points',
        style: {
          fontSize: "18px"
        }
    },
    yAxis: {
      minPadding: 0
    },

    navigator: {
      enabled: true,
    },

    series: [{
        name: 'Hourly data points',
        color: "#ff0000",
        data: data,
        tooltip: {
            valueDecimals: 2
        },
        pointStart: 0,
        pointInterval: 0.002, //.25,     // seconds; 4 fps sampling is 250 ms per frame
        events: { 
          click: function (event) {
            video.pause();
            video.currentTime = Math.floor(event.xAxis[0].value);
          },
        },
    }]
  });

  function overlayImages(canvas, underlay, overlay, alpha, filter) {
    let underImg = new Image();
    let overImg = new Image();
    let ctx = canvas.getContext("2d")
    underImg.onload = function () {
      overImg.src = overlay
    }
    overImg.onload = function () {
      ctx.drawImage(underImg, 0, 0);
      ctx.filter = filter;
      ctx.globalAlpha = alpha;
      ctx.drawImage(overImg, 0, 0);
      ctx.filter = "none";
      ctx.globalAlpha = 1.0;
    }
    underImg.src = underlay;
  }

  let canvas = document.getElementById("roi-vid"),
    avgProjection = document.getElementById("avg-projection"),
    maxProjection = document.getElementById("max-projection"),
    toggleMaskButton = document.getElementById("toggle-mask");
  
  // Preload mask and outline images and save them in an object for toggling
  function RoiImages() {
    let outline = new Image();
    let mask = new Image();
    outline.src = "../resources/roi_mask_outline_128x128.png";
    mask.src = "../resources/roi_mask_128x128.png";
    this.outline = outline;
    this.mask = mask;
  }
    
  var roiOverlays = new RoiImages()

  // Get the "active" ROI overlay image
  function getRoiOverlay() {

    let roi = {"filter": "invert(10%) sepia(93%) saturate(7292%) hue-rotate(11deg) brightness(108%) contrast(118%)",
               "visibility": 1.0};
    let cb_filter = "invert(87%) sepia(27%) saturate(6091%) hue-rotate(353deg) brightness(105%) contrast(102%)"
    let toggleMaskButton = document.getElementById('toggle-mask'),
      toggleVisButton = document.getElementById("toggle-roi"),
      toggleColorblindButton = document.getElementById("toggle-colorblind");
    if (toggleMaskButton.classList.contains("outline")) {
      roi.mask = roiOverlays.outline;
      roi.opacity = 1.0
    } else {
      roi.mask = roiOverlays.mask;
      roi.opacity = 0.5
    }
    if (!toggleVisButton.classList.contains("is-visible")) { roi.visibility = 0.0; }
    if (!toggleColorblindButton.classList.contains("default-colors")) {roi.filter = cb_filter; }
    console.log(roi)
    return roi
  }

  var overlay = getRoiOverlay();
  overlayImages(avgProjection, "../resources/avgint_128x128.png", overlay.mask.src, overlay.opacity, overlay.filter);
  overlayImages(maxProjection, "../resources/maxint_128x128.png", overlay.mask.src, overlay.opacity, overlay.filter);

  function Video(src) {
    let v = document.createElement("video");
    if (src != "") {
      v.src  = src;
    }
    return v;
  }

  function videoProcessor() {
    function step() {
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      ctx.filter = overlay.filter;
      ctx.globalAlpha = overlay.opacity * overlay.visibility;
      ctx.drawImage(overlay.mask, 0, 0);
      ctx.filter = "none";
      ctx.globalAlpha = 1.0;
      requestAnimationFrame(step);
  }
    let ctx = canvas.getContext("2d"),
      overlay = getRoiOverlay();
    requestAnimationFrame(step);
  }

  video.addEventListener('play', function () {
    videoProcessor();
  }, false);

  toggleMaskButton.addEventListener("click", function () {
    let overlay = getRoiOverlay();
    overlayImages(avgProjection, "../resources/avgint_128x128.png", overlay.mask.src, overlay.opacity, overlay.filter);
    overlayImages(maxProjection, "../resources/maxint_128x128.png", overlay.mask.src, overlay.opacity, overlay.filter);
    videoProcessor();
  }, false);

    // Toggle ROI on and off
  function toggleColorblind() {
    let colorButton = document.getElementById("toggle-colorblind");
    if (colorButton.classList.contains("default-colors")) {
      colorButton.classList.remove("default-colors");
      colorButton.innerHTML = "Default Colors"
    } else {
      colorButton.classList.add("default-colors");
      colorButton.innerHTML = "Colorblind Mode";
    }
    overlay = getRoiOverlay();
    overlayImages(avgProjection, "../resources/avgint_128x128.png", overlay.mask.src, overlay.opacity * overlay.visibility, overlay.filter);
    overlayImages(maxProjection, "../resources/maxint_128x128.png", overlay.mask.src, overlay.opacity * overlay.visibility, overlay.filter);
    videoProcessor();
  }


  function toggleRoiVis() {
    let visButton = document.getElementById("toggle-roi");
    if (visButton.classList.contains("is-visible")) {
      visButton.classList.remove("is-visible");
      visButton.innerHTML = "Show ROI"
    } else {
      visButton.classList.add("is-visible");
      visButton.innerHTML = "Hide ROI"
    }
    overlay = getRoiOverlay();
    overlayImages(avgProjection, "../resources/avgint_128x128.png", overlay.mask.src, overlay.opacity * overlay.visibility, overlay.filter);
    overlayImages(maxProjection, "../resources/maxint_128x128.png", overlay.mask.src, overlay.opacity * overlay.visibility, overlay.filter);
    videoProcessor();
  }

  visButton = document.getElementById("toggle-roi");
  visButton.addEventListener("click", function () {
    toggleRoiVis();
  });

  videoButton.addEventListener('click', function(e) {
    let isPlaying = video.currentTime > 0 && !video.paused && !video.ended 
    && video.readyState > 2;
    if (!isPlaying) {
      video.play();
    } else {
      video.pause();
    }
  });

  function togglePlayPause() {
    var isPlaying = !video.paused && !video.ended;
    if (!isPlaying){
      videoButton.innerHTML = "<i class='material-icons'>play_circle_outline</i>"
    }
    else {
      videoButton.innerHTML = "<i class='material-icons'>pause_circle_outline</i>"
    }
  }

  function updateProgress() {
      let value = video.currentTime / video.duration * 100;
      progressFill.style.width = value.toString() + "%"
      progressFill.style.flexBasis = value.toString() + "%"
  }
  
  video.addEventListener('play', function() {
    togglePlayPause();
  }, false);

  video.addEventListener('pause', function() {
    togglePlayPause();
  }, false);

  video.addEventListener('ended', function() {
    togglePlayPause();
  }, false);

  video.addEventListener("timeupdate", function() {
    updateProgress()
  }, false);

    // Swap between masks and outlines
  function toggleMaskOutline() {
    let toggleMaskButton = document.getElementById('toggle-mask')
    if (toggleMaskButton.classList.contains("outline")) {
      toggleMaskButton.classList.remove("outline");
      toggleMaskButton.innerHTML = "Show Mask Outline";
    }
    else {
      toggleMaskButton.innerHTML = "Show Mask Overlay";
      toggleMaskButton.classList.add("outline");
      roiElements = document.getElementsByClassName("roi-image");
    }
  }

  function playVideoSelection(video, startTime, endTime) {
    // Play the video from startTime to endTime
    video.removeEventListener("timeupdate", pauseAtTime);
    let isPlaying = video.currentTime > 0 && !video.paused && !video.ended;
    if (endTime <= startTime) throw "Selection end must be after start.";
    if (!isPlaying) {
      video.currentTime = startTime;
      video.play();
    } else {
      video.currentTime = startTime;
    }
    var pauseAtTime = function(){
      if (video.currentTime >= endTime) {
        video.pause();
        video.removeEventListener("timeupdate", pauseAtTime);
      };
    }
    video.addEventListener("timeupdate", pauseAtTime);
  };

  </script>